name: deploy

on:
    workflow_run:
        workflows: ["unit test"]
        types:
            - completed
        branches: [main, feature/*, develop]
    # Enable manual triggers for testing
    workflow_dispatch:

concurrency: production_environment

jobs:
    deploy:
        if: ${{ github.event.workflow_run.conclusion == 'success' }}
        runs-on: ubuntu-latest
        strategy:
            matrix:
                sprint: ["5-with-bugs"]
        env:
            NODE_VERSION: ${{ matrix.sprint == '5' && '22.2.0' || '16' }}
            SECRET_GOOGLE_ID: ${{ matrix.sprint == '5' && secrets.SECRET_GOOGLE_ID || '' }}
            SECRET_GOOGLE_SECRET: ${{ matrix.sprint == '5' && secrets.SECRET_GOOGLE_SECRET || '' }}
            SECRET_GITHUB_ID: ${{ matrix.sprint == '5' && secrets.SECRET_GITHUB_ID || '' }}
            SECRET_GITHUB_SECRET: ${{ matrix.sprint == '5' && secrets.SECRET_GITHUB_SECRET || '' }}
            # Environment detection - Use workflow_run context for correct branch info
            TRIGGERING_BRANCH: ${{ github.event.workflow_run.head_branch }}
            ENVIRONMENT: ${{ github.event.workflow_run.head_branch == 'main' && 'production' || (github.event.workflow_run.head_branch == 'develop' && 'qa' || 'staging') }}
            VPS_HOST: ${{ github.event.workflow_run.head_branch == 'main' && 'prod-vps.example.com' || 'qa-vps.example.com' }}
        steps:
            - uses: actions/checkout@v4

            - name: Detect Environment ğŸ¯
              run: |
                  echo "ğŸŒ Environment: ${{ env.ENVIRONMENT }}"
                  echo "ğŸ–¥ï¸ Target VPS: ${{ env.VPS_HOST }}"
                  echo "ğŸŒ¿ Triggering Branch: ${{ env.TRIGGERING_BRANCH }}"
                  echo "ğŸ”— Triggering Workflow: ${{ github.event.workflow_run.name }}"
                  echo "ğŸ“‹ Triggering Run ID: ${{ github.event.workflow_run.id }}"

            # ...existing setup steps...

            # Production Deployment - Fix condition to use workflow_run context
            - name: Deploy to Production VPS ğŸš€
              if: github.event.workflow_run.head_branch == 'main'
              run: |
                  echo "ğŸ­ PRODUCTION DEPLOYMENT"
                  echo "=========================================="
                  echo "ğŸ–¥ï¸ Connecting to Production VPS: prod-vps.example.com"
                  echo "ğŸ” Using production SSH key"
                  echo "ğŸŒ¿ Deploying from main branch"
                  echo "âš™ï¸ Environment: production"
                  echo "ğŸ—„ï¸ Database: production_db"
                  echo "ğŸš€ Starting production deployment..."
                  sleep 3
                  echo "âœ… Code pulled from main branch"
                  echo "âœ… Dependencies installed"
                  echo "âœ… Database migrations applied"
                  echo "âœ… Cache cleared and optimized"
                  echo "âœ… Production services restarted"
                  echo "ğŸ‰ PRODUCTION DEPLOYMENT COMPLETED!"

            # QA Deployment - Fix condition
            - name: Deploy to QA VPS ğŸ§ª
              if: github.event.workflow_run.head_branch == 'develop'
              run: |
                  echo "ğŸ§ª QA DEPLOYMENT"
                  echo "=========================================="
                  echo "ğŸ–¥ï¸ Connecting to QA VPS: qa-vps.example.com"
                  echo "ğŸ” Using QA SSH key"
                  echo "ğŸŒ¿ Deploying from develop branch"
                  echo "âš™ï¸ Environment: qa"
                  echo "ğŸ—„ï¸ Database: qa_db"
                  echo "ğŸ§ª Starting QA deployment..."
                  sleep 2
                  echo "âœ… Code pulled from develop branch"
                  echo "âœ… Dependencies installed"
                  echo "âœ… Test database seeded"
                  echo "âœ… Debug mode enabled"
                  echo "âœ… QA services restarted"
                  echo "ğŸ‰ QA DEPLOYMENT COMPLETED!"

            # Developer/Feature Deployment - Fix condition
            - name: Deploy to Dev VPS ğŸ‘¨â€ğŸ’»
              if: startsWith(github.event.workflow_run.head_branch, 'feature/')
              run: |
                  echo "ğŸ‘¨â€ğŸ’» DEV DEPLOYMENT"
                  echo "=========================================="
                  echo "ğŸ–¥ï¸ Connecting to Dev VPS: dev-vps.example.com"
                  echo "ğŸ” Using Dev SSH key"
                  echo "ğŸŒ¿ Deploying from ${{ github.event.workflow_run.head_branch }} branch"
                  echo "âš™ï¸ Environment: dev"
                  echo "ğŸ—„ï¸ Database: dev_db"
                  echo "ğŸ‘¨â€ğŸ’» Starting Dev deployment..."
                  sleep 1
                  echo "âœ… Code pulled from ${{ github.event.workflow_run.head_branch }} branch"
                  echo "âœ… Dependencies installed"
                  echo "âœ… Dev database seeded"
                  echo "âœ… Debug mode enabled"
                  echo "âœ… Dev services restarted"
                  echo "ğŸ‰ DEV DEPLOYMENT COMPLETED!"

            # Environment-specific post-deployment tasks - Fix conditions
            - name: Production Post-Deployment Tasks ğŸ­
              if: github.event.workflow_run.head_branch == 'main'
              run: |
                  echo "ğŸ”§ Running production post-deployment tasks..."
                  echo "âœ… SSL certificates verified"
                  echo "âœ… CDN cache purged"
                  echo "âœ… Monitoring alerts configured"
                  echo "âœ… Backup jobs scheduled"
                  echo "ğŸ“§ Production deployment notification sent"

            - name: QA Post-Deployment Tasks ğŸ§ª
              if: github.event.workflow_run.head_branch == 'develop'
              run: |
                  echo "ğŸ”§ Running QA post-deployment tasks..."
                  echo "âœ… Test data populated"
                  echo "âœ… Debug tools enabled"
                  echo "âœ… Test reports configured"
                  echo "ğŸ§ª Smoke tests initiated"
                  echo "ğŸ“§ QA deployment notification sent"

            - name: Dev Post-Deployment Tasks ğŸ‘¨â€ğŸ’»
              if: startsWith(github.event.workflow_run.head_branch, 'feature/')
              run: |
                  echo "ğŸ”§ Running Dev post-deployment tasks..."
                  echo "âœ… Dev test data populated"
                  echo "âœ… Dev debug tools enabled"
                  echo "âœ… Dev test reports configured"
                  echo "ğŸ‘¨â€ğŸ’» Dev smoke tests initiated"
                  echo "ğŸ“§ Dev deployment notification sent"

            - name: Deployment Summary ğŸ“Š
              run: |
                  echo "ğŸ“Š DEPLOYMENT SUMMARY"
                  echo "=========================================="
                  echo "ğŸŒ Environment: ${{ env.ENVIRONMENT }}"
                  echo "ğŸ–¥ï¸ Target Server: ${{ env.VPS_HOST }}"
                  echo "ğŸŒ¿ Branch: ${{ env.TRIGGERING_BRANCH }}"
                  echo "â° Deployment Time: $(date)"
                  echo "ğŸ‘¤ Triggered by: ${{ github.actor }}"
                  echo "ğŸ”— Triggering Commit: ${{ github.event.workflow_run.head_sha }}"
                  echo "âœ… Deployment Status: SUCCESS"
                  echo "=========================================="

                  if [ "${{ env.ENVIRONMENT }}" = "production" ]; then
                    echo "ğŸŒ Production URL: https://prod.practicesoftwaretesting.com"
                  elif [ "${{ env.ENVIRONMENT }}" = "qa" ]; then
                    echo "ğŸŒ QA URL: https://qa.practicesoftwaretesting.com"
                  else
                    echo "ğŸŒ Dev URL: https://dev.practicesoftwaretesting.com"
                  fi
