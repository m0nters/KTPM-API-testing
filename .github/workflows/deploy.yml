name: deploy
on:
  workflow_run:
    workflows: ["run-tests"]
    types:
      - completed
    branches: [main, feature/*, develop]

concurrency: production_environment

jobs:
  deploy:
    # Only run if the test workflow succeeded
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        sprint: ["5-with-bugs"]
    env:
      NODE_VERSION: ${{ matrix.sprint == '5' && '22.2.0' || '16' }}
      SECRET_GOOGLE_ID: ${{ matrix.sprint == '5' && secrets.SECRET_GOOGLE_ID || '' }}
      SECRET_GOOGLE_SECRET: ${{ matrix.sprint == '5' && secrets.SECRET_GOOGLE_SECRET || '' }}
      SECRET_GITHUB_ID: ${{ matrix.sprint == '5' && secrets.SECRET_GITHUB_ID || '' }}
      SECRET_GITHUB_SECRET: ${{ matrix.sprint == '5' && secrets.SECRET_GITHUB_SECRET || '' }}
      # Environment detection
      ENVIRONMENT: ${{ github.event.workflow_run.head_branch == 'main' && 'production' || (github.event.workflow_run.head_branch == 'develop' && 'qa' || 'staging') }}
      VPS_HOST: ${{ github.event.workflow_run.head_branch == 'main' && 'prod-vps.example.com' || 'qa-vps.example.com' }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha }}

      - name: Detect Environment ğŸ¯
        run: |
          echo "ğŸŒ Environment: ${{ env.ENVIRONMENT }}"
          echo "ğŸ–¥ï¸ Target VPS: ${{ env.VPS_HOST }}"
          echo "ğŸŒ¿ Branch: ${{ github.event.workflow_run.head_branch }}"

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.3"

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install (dev) Dependencies
        run: |
          cd sprint${{ matrix.sprint }}/API
          composer update --no-progress --prefer-dist

      - name: Install Dependencies
        run: |
          cd sprint${{ matrix.sprint }}/API
          composer update --no-dev --prefer-dist --optimize-autoloader
          composer dump-autoloader -o

      - name: Make envfile
        uses: danielr1996/envsubst-action@1.0.0
        env:
          SECRET_DB: ${{ secrets.SECRET_DB }}
          SECRET_DB_USER: ${{ secrets.SECRET_DB_USER }}
          SECRET_DB_PASS: ${{ secrets.SECRET_DB_PASS }}
          SECRET_GOOGLE_ID: ${{ env.SECRET_GOOGLE_ID }}
          SECRET_GOOGLE_SECRET: ${{ env.SECRET_GOOGLE_SECRET }}
          SECRET_GITHUB_ID: ${{ env.SECRET_GITHUB_ID }}
          SECRET_GITHUB_SECRET: ${{ env.SECRET_GITHUB_SECRET }}
        with:
          input: sprint${{ matrix.sprint }}/API/.env_template
          output: sprint${{ matrix.sprint }}/API/.env

      # Production Deployment
      - name: Deploy to Production VPS ğŸš€
        if: github.event.workflow_run.head_branch == 'main'
        run: |
          echo "ğŸ­ PRODUCTION DEPLOYMENT"
          echo "=========================================="
          echo "ğŸ–¥ï¸ Connecting to Production VPS: prod-vps.example.com"
          echo "ğŸ” Using production SSH key"
          echo "ğŸŒ¿ Deploying from main branch"
          echo "âš™ï¸ Environment: production"
          echo "ğŸ—„ï¸ Database: production_db"
          echo "ğŸš€ Starting production deployment..."
          sleep 3
          echo "âœ… Code pulled from main branch"
          echo "âœ… Dependencies installed"
          echo "âœ… Database migrations applied"
          echo "âœ… Cache cleared and optimized"
          echo "âœ… Production services restarted"
          echo "ğŸ‰ PRODUCTION DEPLOYMENT COMPLETED!"

      # QA Deployment
      - name: Deploy to QA VPS ğŸ§ª
        if: github.event.workflow_run.head_branch == 'develop'
        run: |
          echo "ğŸ§ª QA DEPLOYMENT"
          echo "=========================================="
          echo "ğŸ–¥ï¸ Connecting to QA VPS: qa-vps.example.com"
          echo "ğŸ” Using QA SSH key"
          echo "ğŸŒ¿ Deploying from develop branch"
          echo "âš™ï¸ Environment: qa"
          echo "ğŸ—„ï¸ Database: qa_db"
          echo "ğŸ§ª Starting QA deployment..."
          sleep 2
          echo "âœ… Code pulled from develop branch"
          echo "âœ… Dependencies installed"
          echo "âœ… Test database seeded"
          echo "âœ… Debug mode enabled"
          echo "âœ… QA services restarted"
          echo "ğŸ‰ QA DEPLOYMENT COMPLETED!"

      # Developer/Feature Deployment
      - name: Deploy to Dev VPS ğŸ‘¨â€ğŸ’»
        if: startsWith(github.event.workflow_run.head_branch, 'feature/')
        run: |
          echo "ğŸ‘¨â€ğŸ’» DEV DEPLOYMENT"
          echo "=========================================="
          echo "ğŸ–¥ï¸ Connecting to Dev VPS: dev-vps.example.com"
          echo "ğŸ” Using Dev SSH key"
          echo "ğŸŒ¿ Deploying from ${{ github.event.workflow_run.head_branch }} branch"
          echo "âš™ï¸ Environment: dev"
          echo "ğŸ—„ï¸ Database: dev_db"
          echo "ğŸ‘¨â€ğŸ’» Starting Dev deployment..."
          sleep 1
          echo "âœ… Code pulled from ${{ github.event.workflow_run.head_branch }} branch"
          echo "âœ… Dependencies installed"
          echo "âœ… Dev database seeded"
          echo "âœ… Debug mode enabled"
          echo "âœ… Dev services restarted"
          echo "ğŸ‰ DEV DEPLOYMENT COMPLETED!"

      # Environment-specific post-deployment tasks
      - name: Production Post-Deployment Tasks ğŸ­
        if: github.event.workflow_run.head_branch == 'main'
        run: |
          echo "ğŸ”§ Running production post-deployment tasks..."
          echo "âœ… SSL certificates verified"
          echo "âœ… CDN cache purged"
          echo "âœ… Monitoring alerts configured"
          echo "âœ… Backup jobs scheduled"
          echo "ğŸ“§ Production deployment notification sent"

      - name: QA Post-Deployment Tasks ğŸ§ª
        if: github.event.workflow_run.head_branch == 'develop'
        run: |
          echo "ğŸ”§ Running QA post-deployment tasks..."
          echo "âœ… Test data populated"
          echo "âœ… Debug tools enabled"
          echo "âœ… Test reports configured"
          echo "ğŸ§ª Smoke tests initiated"
          echo "ğŸ“§ QA deployment notification sent"

      - name: Dev Post-Deployment Tasks ğŸ‘¨â€ğŸ’»
        if: startsWith(github.event.workflow_run.head_branch, 'feature/')
        run: |
          echo "ğŸ”§ Running Dev post-deployment tasks..."
          echo "âœ… Dev test data populated"
          echo "âœ… Dev debug tools enabled"
          echo "âœ… Dev test reports configured"
          echo "ğŸ‘¨â€ğŸ’» Dev smoke tests initiated"
          echo "ğŸ“§ Dev deployment notification sent"

      - name: Deployment Summary ğŸ“Š
        run: |
          echo "ğŸ“Š DEPLOYMENT SUMMARY"
          echo "=========================================="
          echo "ğŸŒ Environment: ${{ env.ENVIRONMENT }}"
          echo "ğŸ–¥ï¸ Target Server: ${{ env.VPS_HOST }}"
          echo "ğŸŒ¿ Branch: ${{ github.event.workflow_run.head_branch }}"
          echo "â° Deployment Time: $(date)"
          echo "ğŸ‘¤ Triggered by: ${{ github.event.workflow_run.actor.login }}"
          echo "ğŸ”— Commit: ${{ github.event.workflow_run.head_sha }}"
          echo "âœ… Deployment Status: SUCCESS"
          echo "=========================================="

          if [ "${{ env.ENVIRONMENT }}" = "production" ]; then
            echo "ğŸŒ Production URL: https://prod.practicesoftwaretesting.com"
          elif [ "${{ env.ENVIRONMENT }}" = "qa" ]; then
            echo "ğŸŒ QA URL: https://qa.practicesoftwaretesting.com"
          else
            echo "ğŸŒ Dev URL: https://dev.practicesoftwaretesting.com"
          fi
