name: deploy

on:
    workflow_run:
        workflows: ["unit test"]
        types:
            - completed
        branches: [main, feature/*, develop]
    # Enable manual triggers for testing
    workflow_dispatch:

concurrency: production_environment

jobs:
    deploy:
        if: ${{ github.event.workflow_run.conclusion == 'success' }}
        runs-on: ubuntu-latest
        strategy:
            matrix:
                sprint: ["5-with-bugs"]
        env:
            NODE_VERSION: ${{ matrix.sprint == '5' && '22.2.0' || '16' }}
            SECRET_GOOGLE_ID: ${{ matrix.sprint == '5' && secrets.SECRET_GOOGLE_ID || '' }}
            SECRET_GOOGLE_SECRET: ${{ matrix.sprint == '5' && secrets.SECRET_GOOGLE_SECRET || '' }}
            SECRET_GITHUB_ID: ${{ matrix.sprint == '5' && secrets.SECRET_GITHUB_ID || '' }}
            SECRET_GITHUB_SECRET: ${{ matrix.sprint == '5' && secrets.SECRET_GITHUB_SECRET || '' }}
            # Environment detection - Use workflow_run context for correct branch info
            TRIGGERING_BRANCH: ${{ github.event.workflow_run.head_branch }}
            ENVIRONMENT: ${{ github.event.workflow_run.head_branch == 'main' && 'production' || (github.event.workflow_run.head_branch == 'develop' && 'qa' || 'staging') }}
            VPS_HOST: ${{ github.event.workflow_run.head_branch == 'main' && 'prod-vps.example.com' || 'qa-vps.example.com' }}
        steps:
            - uses: actions/checkout@v4

            - name: Detect Environment 🎯
              run: |
                  echo "🌍 Environment: ${{ env.ENVIRONMENT }}"
                  echo "🖥️ Target VPS: ${{ env.VPS_HOST }}"
                  echo "🌿 Triggering Branch: ${{ env.TRIGGERING_BRANCH }}"
                  echo "🔗 Triggering Workflow: ${{ github.event.workflow_run.name }}"
                  echo "📋 Triggering Run ID: ${{ github.event.workflow_run.id }}"

            # ...existing setup steps...

            # Production Deployment - Fix condition to use workflow_run context
            - name: Deploy to Production VPS 🚀
              if: github.event.workflow_run.head_branch == 'main'
              run: |
                  echo "🏭 PRODUCTION DEPLOYMENT"
                  echo "=========================================="
                  echo "🖥️ Connecting to Production VPS: prod-vps.example.com"
                  echo "🔐 Using production SSH key"
                  echo "🌿 Deploying from main branch"
                  echo "⚙️ Environment: production"
                  echo "🗄️ Database: production_db"
                  echo "🚀 Starting production deployment..."
                  sleep 3
                  echo "✅ Code pulled from main branch"
                  echo "✅ Dependencies installed"
                  echo "✅ Database migrations applied"
                  echo "✅ Cache cleared and optimized"
                  echo "✅ Production services restarted"
                  echo "🎉 PRODUCTION DEPLOYMENT COMPLETED!"

            # QA Deployment - Fix condition
            - name: Deploy to QA VPS 🧪
              if: github.event.workflow_run.head_branch == 'develop'
              run: |
                  echo "🧪 QA DEPLOYMENT"
                  echo "=========================================="
                  echo "🖥️ Connecting to QA VPS: qa-vps.example.com"
                  echo "🔐 Using QA SSH key"
                  echo "🌿 Deploying from develop branch"
                  echo "⚙️ Environment: qa"
                  echo "🗄️ Database: qa_db"
                  echo "🧪 Starting QA deployment..."
                  sleep 2
                  echo "✅ Code pulled from develop branch"
                  echo "✅ Dependencies installed"
                  echo "✅ Test database seeded"
                  echo "✅ Debug mode enabled"
                  echo "✅ QA services restarted"
                  echo "🎉 QA DEPLOYMENT COMPLETED!"

            # Developer/Feature Deployment - Fix condition
            - name: Deploy to Dev VPS 👨‍💻
              if: startsWith(github.event.workflow_run.head_branch, 'feature/')
              run: |
                  echo "👨‍💻 DEV DEPLOYMENT"
                  echo "=========================================="
                  echo "🖥️ Connecting to Dev VPS: dev-vps.example.com"
                  echo "🔐 Using Dev SSH key"
                  echo "🌿 Deploying from ${{ github.event.workflow_run.head_branch }} branch"
                  echo "⚙️ Environment: dev"
                  echo "🗄️ Database: dev_db"
                  echo "👨‍💻 Starting Dev deployment..."
                  sleep 1
                  echo "✅ Code pulled from ${{ github.event.workflow_run.head_branch }} branch"
                  echo "✅ Dependencies installed"
                  echo "✅ Dev database seeded"
                  echo "✅ Debug mode enabled"
                  echo "✅ Dev services restarted"
                  echo "🎉 DEV DEPLOYMENT COMPLETED!"

            # Environment-specific post-deployment tasks - Fix conditions
            - name: Production Post-Deployment Tasks 🏭
              if: github.event.workflow_run.head_branch == 'main'
              run: |
                  echo "🔧 Running production post-deployment tasks..."
                  echo "✅ SSL certificates verified"
                  echo "✅ CDN cache purged"
                  echo "✅ Monitoring alerts configured"
                  echo "✅ Backup jobs scheduled"
                  echo "📧 Production deployment notification sent"

            - name: QA Post-Deployment Tasks 🧪
              if: github.event.workflow_run.head_branch == 'develop'
              run: |
                  echo "🔧 Running QA post-deployment tasks..."
                  echo "✅ Test data populated"
                  echo "✅ Debug tools enabled"
                  echo "✅ Test reports configured"
                  echo "🧪 Smoke tests initiated"
                  echo "📧 QA deployment notification sent"

            - name: Dev Post-Deployment Tasks 👨‍💻
              if: startsWith(github.event.workflow_run.head_branch, 'feature/')
              run: |
                  echo "🔧 Running Dev post-deployment tasks..."
                  echo "✅ Dev test data populated"
                  echo "✅ Dev debug tools enabled"
                  echo "✅ Dev test reports configured"
                  echo "👨‍💻 Dev smoke tests initiated"
                  echo "📧 Dev deployment notification sent"

            - name: Deployment Summary 📊
              run: |
                  echo "📊 DEPLOYMENT SUMMARY"
                  echo "=========================================="
                  echo "🌍 Environment: ${{ env.ENVIRONMENT }}"
                  echo "🖥️ Target Server: ${{ env.VPS_HOST }}"
                  echo "🌿 Branch: ${{ env.TRIGGERING_BRANCH }}"
                  echo "⏰ Deployment Time: $(date)"
                  echo "👤 Triggered by: ${{ github.actor }}"
                  echo "🔗 Triggering Commit: ${{ github.event.workflow_run.head_sha }}"
                  echo "✅ Deployment Status: SUCCESS"
                  echo "=========================================="

                  if [ "${{ env.ENVIRONMENT }}" = "production" ]; then
                    echo "🌐 Production URL: https://prod.practicesoftwaretesting.com"
                  elif [ "${{ env.ENVIRONMENT }}" = "qa" ]; then
                    echo "🌐 QA URL: https://qa.practicesoftwaretesting.com"
                  else
                    echo "🌐 Dev URL: https://dev.practicesoftwaretesting.com"
                  fi
