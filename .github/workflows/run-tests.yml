name: Run Tests

on:
    push:
        branches: [main, develop]
    pull_request:
        branches: [develop, main]

concurrency:
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: true

jobs:
    # Run tests for all branches (feature, develop, main)
    test:
        runs-on: ubuntu-22.04
        strategy:
            matrix:
                test-type: [api, ui]
                include:
                    - test-type: api
                      sprint-folder: sprint5-with-bugs
                    - test-type: ui
                      sprint-folder: sprint5-with-bugs

        steps:
            - name: Checkout ⚙️
              uses: actions/checkout@v4

            # Common setup for both API and UI tests
            - name: Start containers 🐳
              if: matrix.test-type == 'api'
              run: |
                  export DISABLE_LOGGING=true
                  export SPRINT_FOLDER=${{ matrix.sprint-folder }}
                  docker compose -f docker-compose.yml up -d

            - name: Wait for services 🕐
              if: matrix.test-type == 'api'
              run: sleep 60s

            - name: Create & Seed database 🌱
              if: matrix.test-type == 'api'
              run: |
                  docker compose exec -T laravel-api php artisan migrate:refresh --seed

            # API Tests
            - name: Setup PHP for API tests 🐘
              if: matrix.test-type == 'api'
              uses: shivammathur/setup-php@v2
              with:
                  php-version: "8.3"

            - name: Install API Dependencies 📦
              if: matrix.test-type == 'api'
              run: |
                  cd ${{ matrix.sprint-folder }}/API
                  sudo chown -R $USER:$USER .
                  composer install --no-progress --prefer-dist --no-interaction

            - name: Run Laravel Unit Tests 🧪
              if: matrix.test-type == 'api'
              run: |
                  cd ${{ matrix.sprint-folder }}/API
                  cp .env.example .env.testing || cp .env .env.testing
                  echo 'APP_ENV=testing' >> .env.testing
                  echo 'DB_CONNECTION=sqlite' >> .env.testing
                  echo 'DB_DATABASE=:memory:' >> .env.testing
                  echo 'CACHE_DRIVER=array' >> .env.testing
                  echo 'SESSION_DRIVER=array' >> .env.testing
                  echo 'QUEUE_CONNECTION=sync' >> .env.testing

                  php artisan config:clear
                  php artisan test --env=testing --testdox

            # UI Tests
            - name: Install Node ⚙️
              if: matrix.test-type == 'ui'
              uses: actions/setup-node@v4
              with:
                  node-version: 22

            - name: Install UI Dependencies 📦
              if: matrix.test-type == 'ui'
              run: |
                  cd ${{ matrix.sprint-folder }}/UI
                  npm ci --legacy-peer-deps || npm install --legacy-peer-deps

            - name: Cache Playwright browser binaries 🧰
              if: matrix.test-type == 'ui'
              uses: actions/cache@v3
              with:
                  path: "~/.cache/ms-playwright"
                  key: "${{ runner.os }}-playwright-${{ hashFiles('**/package-lock.json') }}"

            - name: Install Playwright 🎭
              if: matrix.test-type == 'ui'
              run: |
                  cd ${{ matrix.sprint-folder }}/UI
                  npx playwright install --with-deps

            - name: Run Playwright Tests 🎭
              if: matrix.test-type == 'ui'
              run: |
                  cd ${{ matrix.sprint-folder }}/UI
                  npx playwright test

            - name: Upload test results 📊
              uses: actions/upload-artifact@v4
              if: always()
              with:
                  name: ${{ matrix.test-type }}-test-results
                  path: |
                      ${{ matrix.sprint-folder }}/UI/playwright-report/
                      ${{ matrix.sprint-folder }}/UI/test-results/
                      ${{ matrix.sprint-folder }}/API/storage/logs/
